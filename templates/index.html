<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SF-HIVE DW VALIDATOR (LLM-AGENT)</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@chgibb/css-spinners@2.2.1/css/spinner/three-quarters.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
        }

        header {
            text-align: center;
            margin-top: 2rem;
        }

        header img {
            max-height: 60px;
            margin-bottom: 0.5rem;
        }

        #tab-buttons {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
    margin-bottom: 1.5rem; 
    position: sticky;
    top: 0;
    z-index: 1000;
    padding: 1rem 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* subtle shadow on scroll */
}

        .tab-button {
            padding: 0.75rem 1.5rem;
            margin: 0 0.5rem; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }

        .tab-button:hover {
            background-color: #ccc;
        }

        .tab-button.active {
            background-color: #333;
            color: white;
        }

        .tab-content {
    display: none;
    margin: 2rem auto;
    max-width: 900px;
    filter: none;              /* Ensure no blur */
    opacity: 1;                /* Ensure full opacity */
    pointer-events: auto;      /* Make sure itâ€™s interactable */
    transition: opacity 0.3s ease-in-out;
}

  .tab-content.active {
    display: block;
    opacity: 1;                /* Ensure full visibility */
    filter: none !important;   /* Override any potential blur filter */
     }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1em;
            margin-bottom: 1.5em;
            background-color: #fafafa;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.01);
        }

        pre {
            max-height: 500px;
            overflow: auto;
            font-size: 0.9em;
            line-height: 1.4;
            background: #f0f0f0;
            padding: 1em;
            border-radius: 6px;
            white-space: pre-wrap;
        }

        summary {
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            color: #333;
        }

        details[open] summary {
            color: #0056b3;
        }

        #discrepancies .card strong,
        #summary .card strong {
            display: inline-block;
            width: 160px;
            color: #333;
        }

        #expanded-scripts details {
            margin-bottom: 1.2em;
        }

        #expanded-scripts summary {
            background-color: #e9ecef;
            padding: 0.6em 1em;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #expanded-scripts summary:hover {
            background-color: #d6dee4;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://cdn-icons-png.flaticon.com/512/3039/3039384.png" alt="Logo">
        <h1>SF-HIVE Data Validation (LLM Agent)</h1>
        <form id="name-form">
            <select name="name" id="entity-dropdown" required style="width: 100%; padding: 0.75rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; margin-top: 1rem;">
                <option value="">-- Select an Entity --</option>
            </select>
            
            <button id="magic-button" type="submit" disabled style="width: 100%; padding: 0.75rem; font-size: 1.1rem; margin-top: 1rem; background-color: #333; color: white; border: none; border-radius: 6px; cursor: not-allowed;">
                Validate
            </button>
        </form>
    </header>

    <div id="spinner" style="text-align: center; display: none">
        <span class="three-quarters-loader" style="width: 100px; height: 100px; border-radius: 50%; border-width: 12px;"></span>
    </div>

    <main id="result" style="display: none">
        <div id="tab-buttons">
            <button class="tab-button active" onclick="switchTab('discrepancy-tab')">Raw Discrepancies</button>
            <button class="tab-button" onclick="switchTab('suggestion-tab')">Suggestions</button>
            <button class="tab-button" onclick="switchTab('expanded-tab')">Expanded Scripts</button>
        </div>

        <div id="discrepancy-tab" class="tab-content active">
            <div id="discrepancies"></div>
        </div>

        <div id="suggestion-tab" class="tab-content">
            <div id="summary"></div>
        </div>

        <div id="expanded-tab" class="tab-content">
            <div id="expanded-scripts"></div>
        </div>
    </main>

    <script>


        const form = document.getElementById("name-form");
        const spinner = document.getElementById("spinner");
        const result = document.getElementById("result");
        const dropdown = document.getElementById("entity-dropdown");
       const validateBtn = document.getElementById("magic-button");


        window.addEventListener("DOMContentLoaded", () => {
    fetch("/metadata")
        .then(res => res.json())
        .then(data => {
            const dropdown = document.getElementById("entity-dropdown");
            const rawList = data.col_list || "";
            const colList = rawList.split(",").map(s => s.trim()).filter(Boolean);

            colList.forEach(item => {
                const option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        })
        .catch(err => {
            alert("Failed to load metadata: " + err);
        });
});

dropdown.addEventListener("change", () => {
    if (dropdown.value) {
        validateBtn.disabled = false;
        validateBtn.style.cursor = "pointer";
        validateBtn.style.backgroundColor = "#007BFF"; // blue when active
    } else {
        validateBtn.disabled = true;
        validateBtn.style.cursor = "not-allowed";
        validateBtn.style.backgroundColor = "#333"; // dark when inactive
    }
});

        form.addEventListener("submit", (ev) => {
            ev.preventDefault();

            result.style.display = "none";
            spinner.style.display = "";

            const formData = new FormData(form);

            fetch("/process", { method: "POST", body: formData })
                .then(response => response.ok ? response.json() : Promise.reject("POST request failed"))
                .then(data => {
                    const summaryContainer = document.getElementById("summary");
                    summaryContainer.innerHTML = "";

                    if (!Array.isArray(data.suggestions)) {
                        summaryContainer.textContent = "No suggestions found.";
                    } else {
                        data.suggestions.forEach((item) => {
                            const card = document.createElement("div");
                            card.className = "card";
                            card.innerHTML = `
                                <strong>Column:</strong> ${item.column}<br>
                                <strong>Hive Value (Expected):</strong> ${item.hive_val}<br>
                                <strong>Snowflake Value (Actual):</strong> ${item.snowflake_val}<br>
                                <strong>Hive File:</strong> ${item.hive_file}<br>
                                <strong>Snowflake File:</strong> ${item.snowflake_file}<br>
                                <strong>Suggestion:</strong>
                                <pre>${item.suggestion}</pre>
                            `;
                            summaryContainer.appendChild(card);
                        });
                    }

                    const discrepanciesContainer = document.getElementById("discrepancies");
                    discrepanciesContainer.innerHTML = "";

                    if (!Array.isArray(data.discrepancies) || data.discrepancies.length === 0) {
                        discrepanciesContainer.textContent = "No raw discrepancies found.";
                    } else {
                        data.discrepancies.forEach(discrepancy => {
                            const card = document.createElement("div");
                            card.className = "card";

                            const hiveValues = discrepancy.hive.join(", ");
                            const snowflakeValues = discrepancy.snowflake.join(", ");
                            const ids = discrepancy.id.join(", ");

                            card.innerHTML = `
                                <strong>Column:</strong> ${discrepancy.columnName}<br>
                                <strong>Hive Values:</strong> ${hiveValues}<br>
                                <strong>Snowflake Values:</strong> ${snowflakeValues}<br>
                                <strong>Impacted IDs:</strong> ${ids}
                            `;
                            discrepanciesContainer.appendChild(card);
                        });
                    }

                    const expandedContainer = document.getElementById("expanded-scripts");
                    expandedContainer.innerHTML = "";

                    const expandedMap = data.expanded_scr_map || {};
                    const fileNames = Object.keys(expandedMap);

                    if (fileNames.length === 0) {
                        expandedContainer.textContent = "No expanded scripts found.";
                    } else {
                        fileNames.forEach((fileName) => {
                            const card = document.createElement("div");
                            card.className = "card";

                            const contentId = `script-${btoa(fileName).replace(/[^a-zA-Z0-9]/g, "")}`;

                            card.innerHTML = `
                                <details>
                                    <summary>${fileName}</summary>
                                    <pre id="${contentId}">${expandedMap[fileName]}</pre>
                                </details>
                            `;
                            expandedContainer.appendChild(card);
                        });
                    }

                    spinner.style.display = "none";
                    result.style.display = "";
                })
                .catch(err => {
                    alert("Failed to validate: " + err);
                    spinner.style.display = "none";
                });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
    </script>
</body>
</html>
